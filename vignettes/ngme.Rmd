---
title: "ngme: an R package for non-Gaussian longitudinal data analysis"
author: "Some lads"
date: "`r Sys.Date()`"
#output: rmarkdown::html_vignette
output:   pdf_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Modelling framework 

The modelling frameworks that the package `ngme` 
provides functions for have the following forms:
$$
\begin{aligned}
Y_{ij} = {\bf x}_{ij}^{\prime} {\bf \alpha} + {\bf d}_{ij}^{\prime} {\bf U}_i + Z_{ij},
\end{aligned}
$$
and
$$
\begin{aligned}
Y_{ij} = {\bf x}_{ij}^{\prime} {\bf \alpha} + {\bf d}_{ij}^{\prime} {\bf U}_i + W_i(t_{ij}) + Z_{ij}.
\end{aligned}
$$
Here, 

- $i = 1, \ldots, m$, $j = 1, \ldots, n_i$, 
- $Y_{ij}$ is the $j$th response for subject $i$ at time $t_{ij}$,
- ${\bf x}_{ij}$ is the matrix of fixed effects explanatory variables,
- ${\bf \alpha}$ is the matrix of fixed effects coefficients,
- ${\bf d}_{ij}$ is the matrix of random effects explanatory variables,
- ${\bf U}_i$ is the matrix of subject-specific and time-invariant random effects coefficients,
- $W_i(t)$ is subject- and time-spceific random effect, specificed as a stochastic process,
- $Z_{ij}$ is random error.

`ngme` includes `nglda_est` and `nglda_predict` as the main functions 
for parameter estimation based on maximum likelihood 
implemented with a computationally efficient stochastic gradient algorithm 
and prediction based on either filtering or smoothing distributions, 
respectively. `print`, `summary`, `plot`, `fitted`, `residuals`, `intervals` 
functions are available as the supplemetary. 
 
Within `ngme` one can choose to specify the distributions as
 
- Normal and Normal-inverse Gaussian (NIG) for ${\bf U}_i$,
- Normal, NIG, generalised asymmetric Laplace (GAL) and Cauchy for $W_i(t)$,
- Normal, NIG and t for $Z_{ij}$.

# Data

The data-set used to illustrate the usage of the package `ngme` comes 
from a primary care cohort on kidney patients in the city of Salford 
in Greater Manchester, United Kingdom. The data-set contains 392,870 
repeated measures in total that belong to 22,910 patients. It contains 
the following variables:

- id: identification number,
- egfr: estimated glomerular filtration rate (eGFR) measurements; 
        this variable is the longitudinal outcome,
- sex: sex of a patient; 0 = male, 1 = female,
- bage: baseline age of a patient (in years),
- fu: follow-up time, $t_{ij}$, (in years), calculated as the difference 
      between age at measurement and age at baseline,
- pwl: a piecewise linear term at the age of 56.5, 
       calculated as max(0, age - 56.5), 
       where age denotes age at measurement. 

For more details of the data-set, see 
Digge, Sousa and Asar (2015, Biostatistics, 16(3), 522-536). 

The code chunk given below shows how to load the data-set and 
exemplifies the data-format by printing the first 10 rows. 

```{r, echo=TRUE}
library(ngme)
data(srft_data)
knitr::kable(head(srft_data, 10))
```

# Analysis

Here we use randomly selected 100 patients' data for the sake 
of computational time. 

```{r, echo=TRUE}
set.seed(123)
rs_id <- sample(unique(srft_data$id), 50, replace = F)
srft_data_sub <- srft_data[srft_data$id %in% rs_id, ]
```

The below code chunk fits the following model:
$$
\log(eGFR)_{ij} = \beta_0 + \beta_1 bage_{i} + \beta_2 sex_i + 
                 \beta_3 t_{ij} + \beta_4 \max(0, age_{ij} - 56.5) + 
                 U_{0i} + U_{1i} t_{ij} + W_i(t_{ij}) + Z_{ij},
$$
with 

- bivariate NIG distributed $U_{0i}$ and $U_{1i}$,
- GAL distributed $W_i(\cdot)$ with Matern covariance family,
- t distributed $Z_{ij}$.

```{r, echo = TRUE}
srft_fit <- ngme(
  fixed = log(egfr) ~ bage + sex + fu + pwl,
  random = ~ fu + bage|id,
  data = srft_data_sub,
  reffects = "NIG",
  process = c("GAL", "matern"),
  error = "tdist",
  timeVar = "fu",
  use.process = T,
  nIter = 100,
  controls = list(nSim.fisher = 10)
)
```
Typing the fitted object's name, `srft_fit`, 
displays a conscise list of results:

```{r, echo = TRUE}
srft_fit
```

`summary` function provides a more thorough list of results:

```{r, echo = TRUE}
summary(srft_fit)
```

Marginal fitted values, $\hat{Y}_{ij} = {\bf x}_{ij} \hat{{\bf \beta}}$, 
and marginal residuals, $Y_{ij} - \hat{Y}_{ij}$ can be obtained using 
the `fitted` and `residual` functions, respectively:

```{r, echo = TRUE}
#just print the first 10 elements for each
head(fitted(srft_fit), 10)
head(residuals(srft_fit), 10)
```

95\% confidence intervals for the fixed effects coefficients 
could be obtained using the `intervals` function:

```{r, echo = TRUE}
intervals(srft_fit)
```

Predictions based on filtering distribution could be obtained using the function 
`nglda_predict`:

```{r, echo = FALSE}
 res.pred <- predict(srft_fit, id = unique(srft_data_sub$id), 
                      type = "Filter", controls = list(silent = T))

```
A summary of results including accuracy measures can be viewed by

```{r, echo = TRUE}
res.pred
```

Predictions for a selected subject, e.g. the first subject in the 
`srft_data_sub`, could be plotted using

```{r, echo = TRUE}
plot(res.pred, id = unique(srft_data_sub$id)[1], pch = 19, cex = 0.5)
```

In this plot, dots are observed data, black lines is the mean 
of the predictive distribution, and red lines are the 95\% 
prediction intervals. 

MORE STUFF???

MAYBE WITH REGARDS PREDICTIONS, EXCURSIONS, MANIPULATIONS OF PREDICTIONS...

